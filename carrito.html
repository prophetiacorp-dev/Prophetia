<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Carrito — Prophetia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body data-page="cart">
  <div id="header"></div>

  <main class="container cart-page">
    <h1 data-i18n="cart.title">Tu carrito</h1>
    <div id="cartPageList" class="cart-table"></div>
    <div class="cart-summary">
      <div><span data-i18n="cart.subtotal">Subtotal</span><strong id="cartPageTotal">€0,00</strong></div>
      <p class="muted" data-i18n="cart.note">Los gastos de envío y las tasas se calculan en el checkout.</p>
      <div class="cart-actions">
        <a class="btn-outline" href="colecciones.html" data-i18n="cart.keepShopping">Seguir comprando</a>
        <button class="btn-primary" id="fakeCheckout" data-i18n="cart.checkout">Finalizar compra</button>
      </div>
    </div>
  </main>

  <div id="footer"></div>
   <script src="assets/js/header-init.js"></script>
  <script src="assets/js/script.js"></script>
    <script>
    // Definición mínima para esta página (usa APIs de ppCart del script.js)
    window.ppInitCartPage = function(){
      const $ = (s)=>document.querySelector(s);
      const listEl  = $('#cartPageList');
      const totalEl = $('#cartPageTotal');
      const cart = window.ppCart?.load() || [];

      if(!listEl || !totalEl) return;

      if (!cart.length){
        listEl.innerHTML = '<p class="muted">Tu cesta está vacía.</p>';
        totalEl.textContent = window.ppCart.money(0);
        return;
      }

      // render sencillo tipo tabla
      let html = '';
      let subtotal = 0;
      cart.forEach((it, i)=>{
        const qty = Number(it.qty||1);
        const price = Number(it.price||0);
        subtotal += price * qty;
        const img = it.img || it.cover || (it.images && it.images[0]) || 'assets/img/placeholder.png';
        html += `
          <article class="cart-item" data-i="${i}">
            <div class="cart-item__thumb"><img src="${img}" alt=""></div>
            <div class="cart-item__body">
              <div class="cart-item__title">${(it.title||'Producto')}</div>
              ${(it.color||it.size)?`<div class="cart-item__meta">${[it.color,it.size].filter(Boolean).join(' · ')}</div>`:''}
              <div class="cart-item__row">
                <button class="cart-btn" data-op="-">−</button>
                <span>${qty}</span>
                <button class="cart-btn" data-op="+">+</button>
                <button class="cart-rm">Eliminar</button>
              </div>
            </div>
            <div class="cart-item__price">${window.ppCart.money(price*qty)}</div>
          </article>`;
      });
      listEl.innerHTML = html;
      totalEl.textContent = window.ppCart.money(subtotal);

      // Mutaciones
      listEl.onclick = (e)=>{
        const row = e.target.closest('.cart-item'); if(!row) return;
        const idx = +row.dataset.i;
        const op  = e.target.closest('[data-op]')?.dataset.op;
        const rm  = e.target.closest('.cart-rm');
        const cart = window.ppCart.load();
        if (op){
          const it = cart[idx]; if(!it) return;
          if (op==='+') it.qty = (Number(it.qty)||1)+1;
          if (op==='-') it.qty = Math.max(1,(Number(it.qty)||1)-1);
          window.ppCart.save(cart);
          window.ppCart.updateBadges();
          window.ppInitCartPage();
        }
        if (rm){
          cart.splice(idx,1);
          window.ppCart.save(cart);
          window.ppCart.updateBadges();
          window.ppInitCartPage();
        }
      };
    };
  </script>

  <script>
    (async function injectHF(){
      const H = await fetch('header.html').then(r=>r.text());
      const F = await fetch('footer.html').then(r=>r.text());
      document.getElementById('header').innerHTML = H;
      document.getElementById('footer').innerHTML = F;
      window.ppInitHeader && window.ppInitHeader();
      // Lógica de render del carrito (ver Cambio 2)
      window.ppInitCartPage && window.ppInitCartPage();
    })();
  </script>

</body>
</html>
