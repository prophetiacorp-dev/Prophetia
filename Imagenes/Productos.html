<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Producto ‚Äî PROPHETIA</title>
  <meta property="og:type" content="product">
  <link rel="icon" href="images/favicon.ico">
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=EUR" defer></script>
</head>
<body class="page-product">
  <div id="announceBar" class="announce-bar">
    <span>üöö Env√≠o 48‚Äì72h ¬∑ üîÅ Devoluciones 14 d√≠as ¬∑ ‚ú® Pago seguro</span>
    <button id="closeAnnounce" aria-label="Cerrar">√ó</button>
  </div>

  <header class="site-header">
    <a class="brand" href="index.html" aria-label="Inicio">PROPHETIA</a>
    <button class="nav-toggle" aria-label="Abrir men√∫">‚ò∞</button>
    <nav class="site-nav">
      <div class="dropdown">
        <a href="colecciones.html">Collections ‚ñæ</a>
        <div class="dropdown-menu">
          <a href="colecciones.html#myth-series">Myth Series</a>
          <a href="colecciones.html#letters-from-the-soul">Letters from the Soul</a>
        </div>
      </div>
      <a href="index.html#about">About</a>
      <a href="index.html#journal">Journal</a>
      <a href="index.html#contact">Contact</a>
      <button class="cart-btn" aria-label="Carrito">üõí <span id="cartCount">0</span></button>
    </nav>
  </header>

  <aside id="cartDrawer" class="cart-drawer">
    <div class="cart-head"><strong>Tu carrito</strong><button id="closeCart">√ó</button></div>
    <div id="cartItems" class="cart-items"></div>
    <div class="cart-foot">
      <div class="cart-total"><span>Total</span><strong id="cartTotal">‚Ç¨0</strong></div>
      <div class="coupon-row">
        <input id="couponInput" type="text" placeholder="C√≥digo de descuento">
        <button id="applyCoupon" class="btn-primary" type="button">Aplicar</button>
      </div>
      <div id="couponNote" class="coupon-applied" style="display:none;">C√≥digo aplicado: <span id="couponName"></span></div>
      <button id="checkoutBtn" class="btn-primary">Finalizar (demo)</button>
    </div>
  </aside>
  <div id="cartBackdrop" class="cart-backdrop"></div>

  <main class="product-wrap">
    <section class="product-gallery">
      <img id="pMain" src="" alt="Vista principal" />
      <div id="pThumbs" class="thumbs"></div>
    </section>

    <section class="product-info">
      <h1 id="pTitle"></h1>
      <p id="pDesc" class="lede"></p>
      <div class="price-row"><span id="pPrice" class="price"></span><span class="tax-note">IVA incl.</span></div>

      <div id="sizeRow" class="size-row"></div>
      <div class="qty-row"><label for="qty">Cantidad</label><input id="qty" type="number" min="1" value="1"></div>

      <form id="buyForm" class="buy-form">
        <button type="submit" class="btn-primary">A√±adir al carrito</button>
      </form>

      <div id="paypalPay" class="paypal-wrap"></div>

      <details class="accordion" open>
        <summary>Detalles</summary>
        <ul class="bullets">
          <li>Algod√≥n peinado 100% (190‚Äì220 g/m¬≤)</li>
          <li>Print en PNG transparente 4K (DTG/DTF)</li>
          <li>Corte regular/oversize</li>
          <li>Hecho en ___; estampado en Espa√±a</li>
        </ul>
      </details>
    </section>
  </main>

  <div id="stickyBar" class="sticky-bar">
    <span id="stickyTitle"></span>
    <div class="sticky-actions"><span id="stickyPrice"></span><button id="stickyAdd" class="btn-primary">A√±adir</button></div>
  </div>

  <script id="jsonld" type="application/ld+json"></script>

  <!-- Pop-up registro + descuento -->
  <div id="welcomeBackdrop" class="modal-backdrop"></div>
  <div id="welcomeModal" class="modal">
    <button id="welcomeClose" class="modal-close" aria-label="Cerrar">√ó</button>
    <h3>-10% en tu primera compra</h3>
    <p class="lede">Suscr√≠bete para recibir tu c√≥digo de bienvenida.</p>
    <form id="welcomeForm" class="nl-form">
      <input id="welcomeEmail" type="email" placeholder="tu@email.com" required>
      <button type="submit" class="btn-primary">Recibir c√≥digo</button>
      <small class="muted">Sin spam.</small>
    </form>
    <div id="welcomeCodeBox" class="nl-thanks" hidden>
      <p style="margin-bottom:.5rem;">Tu c√≥digo:</p>
      <div id="welcomeCode" style="font-weight:700; font-size:1.2rem; letter-spacing:.5px;">PROPHETIA10</div>
      <button id="copyCode" class="btn-primary" style="margin-top:.75rem;">Copiar y aplicar</button>
      <small class="muted">Se aplicar√° autom√°ticamente en el carrito.</small>
    </div>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>document.addEventListener('DOMContentLoaded',()=>{ if(window.emailjs){ emailjs.init({ publicKey:"YOUR_EMAILJS_PUBLIC_KEY" }); }});</script>
  <script src="script.js"></script>

  <!-- PayPal con descuento aplicado -->
  <script>
  (async function mountPayPal(){
    const wrap = document.getElementById('paypalPay');
    if(!wrap) return;

    const slug = new URLSearchParams(location.search).get('slug');
    const res  = await fetch('catalog.json', {cache:'no-store'});
    const list = await res.json();
    const p    = list.find(x=>x.slug===slug);
    if(!p || !window.paypal) return;

    const qtyInput = document.getElementById('qty');
    const sizeRow  = document.getElementById('sizeRow');
    let currentSize = null;

    sizeRow?.querySelectorAll('.size-btn').forEach(btn=>{
      if(btn.classList.contains('active')) currentSize = btn.dataset.size;
      btn.addEventListener('click', ()=> currentSize = btn.dataset.size);
    });

    // cup√≥n activo (sincronizado con script.js)
    const DISCOUNT_PCT = 10;
    function hasActiveCoupon(){
      try{
        const code  = localStorage.getItem('pp_coupon_applied');
        const until = parseInt(localStorage.getItem('pp_coupon_expires_at')||'0',10);
        return code === 'PROPHETIA10' && Date.now() < until;
      }catch{ return false; }
    }

    paypal.Buttons({
      style:{ layout:'vertical', color:'gold', shape:'rect', label:'paypal' },
      createOrder: (data, actions)=>{
        const qty  = Math.max(1, parseInt(qtyInput?.value || '1', 10));
        const size = currentSize || 'S';
        const base = Number(p.price||0) * qty;
        const final = hasActiveCoupon() ? base * (1 - DISCOUNT_PCT/100) : base;

        const unit = hasActiveCoupon()
          ? (Number(p.price||0) * (1 - DISCOUNT_PCT/100)).toFixed(2)
          : Number(p.price||0).toFixed(2);

        return actions.order.create({
          purchase_units:[{
            amount:{ currency_code:'EUR', value: final.toFixed(2) },
            items:[{
              name:`${p.title} (Talla ${size})`,
              unit_amount:{ currency_code:'EUR', value: unit },
              quantity:String(qty),
              sku: p.sku || p.slug
            }]
          }]
        });
      },
      onApprove: async (data, actions)=>{
        await actions.order.capture();
        alert('¬°Gracias! Pedido pagado con PayPal.');
      },
      onError: (err)=>{ console.error(err); alert('Error en el pago.'); }
    }).render(wrap);
  })();
  </script>
</body>
</html>
